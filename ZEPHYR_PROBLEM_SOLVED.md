# üîß –†–ï–®–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú ZEPHYR SAP –î–ï–ö–û–ú–ü–û–ó–ò–¶–ò–ò

## –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ Zephyr –¥–ª—è SAP –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–∏ —Å–∏—Å—Ç–µ–º–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å–∞–º –ø—Ä–æ–º—Ç –≤–º–µ—Å—Ç–æ –µ–≥–æ —Ä–∞–∑–ª–æ–∂–µ–Ω–∏—è:

```
‚ùå Parsing failed: Could not find dictionary pattern in response
   Response snippet: A horse riding a bicycle
```

## –ü—Ä–∏—á–∏–Ω—ã

### 1. **–ë–∞—Ç—á-–æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–º—Ç–æ–≤** ‚ùå (–ò–°–ü–†–ê–í–õ–ï–ù–û)
**–ë—ã–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞:** –°–∏—Å—Ç–µ–º–∞ –ø—ã—Ç–∞–ª–∞—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ –ø—Ä–æ–º—Ç—ã –≤ –æ–¥–Ω–æ–º –≤—ã–∑–æ–≤–µ LLM.
- Zephyr —Å `max_new_tokens=256` –Ω–µ –º–æ–≥ –≤—ã–¥–∞—Ç—å –ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–º—Ç–æ–≤
- –í–æ–∑–≤—Ä–∞—â–∞–ª —Ç–æ–ª—å–∫–æ –ø–µ—Ä–≤—ã–π –ø—Ä–æ–º—Ç –≤–º–µ—Å—Ç–æ –µ–≥–æ —Ä–∞–∑–ª–æ–∂–µ–Ω–∏—è

**–†–µ—à–µ–Ω–∏–µ:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–º—Ç–∞ –æ—Ç–¥–µ–ª—å–Ω–æ (–æ–¥–∏–Ω LLM –≤—ã–∑–æ–≤ = –æ–¥–∏–Ω –ø—Ä–æ–º—Ç)
```python
# –î–û (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
full_prompt = template + all_prompts  # –í—Å–µ –ø—Ä–æ–º—Ç—ã –≤ –æ–¥–Ω–æ–º –∑–∞–ø—Ä–æ—Å–µ
output = pipe(full_prompt, max_new_tokens=256)  # –ü–æ–ª—É—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞—á–∞–ª–æ

# –ü–û–°–õ–ï (–ø—Ä–∞–≤–∏–ª—å–Ω–æ)
for prompt in prompts_list:
    full_prompt = template + prompt  # –û–¥–∏–Ω –ø—Ä–æ–º—Ç
    output = pipe(full_prompt, max_new_tokens=512)  # –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ø–∞–º—è—Ç–∏
```

### 2. **–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ max_new_tokens**
- `max_new_tokens=256` –±—ã–ª –º–∞–ª –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
- –ú–æ–¥–µ–ª—å –≤—ã–¥–∞–≤–∞–ª–∞ –Ω–µ–ø–æ–ª–Ω—ã–π –æ—Ç–≤–µ—Ç –±–µ–∑ JSON —Å—Ç—Ä—É–∫—Ç—É—Ä—ã

**–†–µ—à–µ–Ω–∏–µ:** –£–≤–µ–ª–∏—á–µ–Ω–æ –¥–æ `max_new_tokens=512`

### 3. **–í—ã—Å–æ–∫–∞—è temperature**
- `temperature=0.7` –¥–µ–ª–∞–ª –≤—ã–≤–æ–¥ —Å–ª–∏—à–∫–æ–º —Å–ª—É—á–∞–π–Ω—ã–º
- Zephyr –¥–∞–≤–∞–ª –Ω–µ–ø—Ä–µ–¥—Å–∫–∞–∑—É–µ–º–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã

**–†–µ—à–µ–Ω–∏–µ:** –£–º–µ–Ω—å—à–µ–Ω–æ –¥–æ `temperature=0.5` –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏

## –ß—Ç–æ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ

### 1. `llm_interface/llm_SAP.py` - –§—É–Ω–∫—Ü–∏—è `LLM_SAP_batch_Zephyr()`

**–ë—ã–ª–æ:**
```python
def LLM_SAP_batch_Zephyr(prompts_list, llm_model):
    # –°–æ–∑–¥–∞–≤–∞–ª –æ–¥–∏–Ω –±–æ–ª—å—à–æ–π –ø—Ä–æ–º—Ç —Å–æ –≤—Å–µ–º–∏ –ø—Ä–∏–º–µ—Ä–∞–º–∏
    numbered_prompts = [f"### Input {i + 1}: {p}\n### Output:" for i, p in enumerate(prompts_list)]
    prompt_user = template_user + "\n\n" + "\n\n".join(numbered_prompts)
    
    # –û–¥–∏–Ω –≤—ã–∑–æ–≤ LLM –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–º—Ç–æ–≤
    output = pipe(full_prompt, max_new_tokens=256)
    
    # –ü–æ–ø—ã—Ç–∫–∞ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –æ—Ç–≤–µ—Ç - –æ–±—ã—á–Ω–æ –Ω–µ—É–¥–∞—á–Ω–∞—è
    parsed_outputs = parse_batched_llm_output(output, prompts_list)
```

**–°—Ç–∞–ª–æ:**
```python
def LLM_SAP_batch_Zephyr(prompts_list, llm_model):
    all_outputs = []
    
    for i, prompt in enumerate(prompts_list):
        # –û–¥–∏–Ω –ø—Ä–æ–º—Ç –∑–∞ —Ä–∞–∑
        numbered_prompt = f"### Input 1: {prompt}\n### Output:"
        full_prompt = template_system + "\n\n" + template_user + "\n\n" + numbered_prompt
        
        # –û—Ç–¥–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ LLM –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–º—Ç–∞
        output = pipe(
            full_prompt,
            max_new_tokens=512,  # –£–≤–µ–ª–∏—á–µ–Ω–æ
            temperature=0.5,      # –£–º–µ–Ω—å—à–µ–Ω–æ
            do_sample=True,
            top_p=0.95,
            return_full_text=False
        )[0]["generated_text"]
        
        # –ü–∞—Ä—Å–∏–Ω–≥ –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        result = get_params_dict_SAP(output)
        if result is not None:
            all_outputs.append(result)
        else:
            # Fallback –¥–ª—è –Ω–µ—É–¥–∞—á–Ω—ã—Ö –ø–∞—Ä—Å–æ–≤
            all_outputs.append(create_fallback_decomposition(prompt))
```

## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

### –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç (1-2 –º–∏–Ω—É—Ç—ã)
```bash
cd /home/andrn/Image_Gen_Test2/SAP

# –¢–µ—Å—Ç 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ Zephyr pipeline
python test_zephyr_sap.py
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´! Zephyr —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.
```

### –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç (10-20 –º–∏–Ω—É—Ç)
```bash
# –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ 5 SAP –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏–π —Å Zephyr
python generate_sap_prompts.py \
  --prompts-file prompts.txt \
  --output-file test_sap.json \
  --llm Zephyr
```

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
```
‚úÖ –£—Å–ø–µ—à–Ω–æ: 5 / 5
‚úÖ –û—à–∏–±–æ–∫: 0 / 5
```

## –ü–∞—Ä–∞–º–µ—Ç—Ä—ã Zephyr (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å)

–í —Ñ–∞–π–ª–µ `llm_interface/llm_SAP.py`:

```python
output = pipe(
    full_prompt,
    max_new_tokens=512,      # ‚Üë –ë–æ–ª—å—à–µ = –±–æ–ª–µ–µ –ø–æ–ª–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã (–º–µ–¥–ª–µ–Ω–Ω–µ–µ)
    temperature=0.5,         # ‚Üì –ú–µ–Ω—å—à–µ = –±–æ–ª–µ–µ –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ (–Ω–æ —Å–∫—É—á–Ω–µ–µ)
    do_sample=True,
    top_p=0.95,              # Nucleus sampling - –∫–∞—á–µ—Å—Ç–≤–æ
    return_full_text=False
)
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:**
- `max_new_tokens`: 256-1024 (–∑–∞–≤–∏—Å–∏—Ç –æ—Ç VRAM)
- `temperature`: 0.3-0.7 (0.5 - –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ –¥–ª—è SAP)
- `top_p`: 0.9-0.99 (0.95 - —Ö–æ—Ä–æ—à–æ)

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è (–µ—Å–ª–∏ –≤—Å—ë –µ—â—ë –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å GPT –≤–º–µ—Å—Ç–æ Zephyr
```bash
export OPENAI_API_KEY="sk-..."
python workflow_example.py --step 1 --llm GPT
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –£–≤–µ–ª–∏—á–∏—Ç—å VRAM –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
```python
# –í load_Zephyr_pipeline()
model = AutoModelForCausalLM.from_pretrained(
    model_id,
    torch_dtype=torch.float32,  # –ë–æ–ª—å—à–µ –ø–∞–º—è—Ç—å, –º–µ–¥–ª–µ–Ω–Ω–µ–µ
    device_map="auto"
)
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å fallback –¥–ª—è –≤—Å–µ—Ö –ø—Ä–æ–º—Ç–æ–≤
–°–∏—Å—Ç–µ–º–∞ —É–∂–µ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –µ—Å–ª–∏ Zephyr –Ω–µ –º–æ–∂–µ—Ç —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø—Ä–æ—Å—Ç–∞—è fallback –¥–µ–∫–æ–º–ø–æ–∑–∏—Ü–∏—è (—Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ 2 —ç—Ç–∞–ø–∞).

## –ß—Ç–æ –¥–∞–ª—å—à–µ?

‚úÖ **–¢–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```bash
# –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ SAP —Å Zephyr
python workflow_example.py --step 1 --llm Zephyr

# –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–π SAP
python workflow_example.py --step 2 --mode sap --sap-output SAP_prompts.json

# –ò–ª–∏ —Å—Ä–∞–∑—É –≤—Å—ë –≤–º–µ—Å—Ç–µ
python workflow_example.py --full --llm Zephyr --mode sap
```

## –î–µ—Ç–∞–ª–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –ë—ã–ª–æ | –°—Ç–∞–ª–æ | –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ |
|-----------|------|-------|-------------|
| –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–º—Ç–æ–≤ | –ë–∞—Ç—á –≤—Å–µ—Ö —Å—Ä–∞–∑—É | –ü–æ –æ–¥–Ω–æ–º—É | –ü–æ–ª–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã |
| max_new_tokens | 256 | 512 | –ë–æ–ª—å—à–µ –º–µ—Å—Ç–æ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ |
| temperature | 0.7 | 0.5 | –ö–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–µ–µ |
| –ü–∞—Ä—Å–∏–Ω–≥ | parse_batched_llm_output | get_params_dict_SAP | –ë–æ–ª–µ–µ –≥–∏–±–∫–æ |
| Fallback | –ü—Ä–æ—Å—Ç–∞—è –¥–µ–ª–µ–Ω–∏—è | create_fallback_decomposition | –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–µ–µ |

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

**–ë—ã–ª–æ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ):** ~2-3 —Å–µ–∫ –Ω–∞ –≤—Å–µ –ø—Ä–æ–º—Ç—ã, –Ω–æ –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞  
**–°—Ç–∞–ª–æ (–ø—Ä–∞–≤–∏–ª—å–Ω–æ):** ~10-15 —Å–µ–∫ –Ω–∞ –≤—Å–µ –ø—Ä–æ–º—Ç—ã, –Ω–æ –Ω–∞–¥—ë–∂–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

- –ú–µ–¥–ª–µ–Ω–Ω–µ–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ LLM –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–º—Ç–∞
- –ù–æ –Ω–∞–¥—ë–∂–Ω–µ–µ, –ø–æ—Ç–æ–º—É —á—Ç–æ –∫–∞–∂–¥—ã–π –∑–∞–ø—Ä–æ—Å –∏–º–µ–µ—Ç –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

–î–ª—è –±–æ–ª—å—à–∏—Ö –Ω–∞–±–æ—Ä–æ–≤ –ø—Ä–æ–º—Ç–æ–≤ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
```bash
# –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–¥–∏–Ω —Ä–∞–∑ —Å GPT (–±—ã—Å—Ç—Ä–æ, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–æ)
export OPENAI_API_KEY="sk-..."
python workflow_example.py --step 1 --llm GPT

# –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º –º–Ω–æ–≥–æ —Ä–∞–∑ —Å –ª–æ–∫–∞–ª—å–Ω–æ–π FLUX (–¥–µ—à–µ–≤–æ)
python workflow_example.py --step 2 --sap-output SAP_prompts.json
```
