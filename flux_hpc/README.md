# FLUX HPC Image Generator - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ

–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–¥–µ–ª—å–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º FLUX –º–æ–¥–µ–ª–∏ –Ω–∞ HPC –∫–ª–∞—Å—Ç–µ—Ä–µ –±–µ–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.

## üìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
flux_hpc/
‚îú‚îÄ‚îÄ 01_download_models.py      # –°–∫—Ä–∏–ø—Ç –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π (–∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∑–æ–Ω–∞)
‚îú‚îÄ‚îÄ 02_generate_images.py      # –°–∫—Ä–∏–ø—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π (HPC –∫–ª–∞—Å—Ç–µ—Ä)
‚îú‚îÄ‚îÄ script.sbatch              # SLURM —Å–∫—Ä–∏–ø—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π)
‚îú‚îÄ‚îÄ download_models.sbatch     # SLURM —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ (–∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∑–æ–Ω–∞)
‚îú‚îÄ‚îÄ setup_directories.sh       # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
‚îú‚îÄ‚îÄ prompts.json               # –§–∞–π–ª —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏ (–ø—Ä–∏–º–µ—Ä)
‚îú‚îÄ‚îÄ requirements.txt           # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python
‚îî‚îÄ‚îÄ README.md                  # –≠—Ç–æ—Ç —Ñ–∞–π–ª
```

## üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

### –®–∞–≥ 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –ù–∞ –º–∞—à–∏–Ω–µ —Å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–æ–º:
conda create -n flux_env python=3.10
conda activate flux_env
pip install -r requirements.txt
```

### –®–∞–≥ 2: –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π (–≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–¥–æ—Å—Ç—É–ø–Ω–æ–π –∑–æ–Ω–µ)

**–í–ê–ñ–ù–û**: –≠—Ç–æ—Ç —à–∞–≥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –û–î–ò–ù –†–ê–ó –∏ —Ç—Ä–µ–±—É–µ—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –¥–æ—Å—Ç—É–ø!

**–í–∞—Ä–∏–∞–Ω—Ç –ê: –ü—Ä—è–º–æ–π –∑–∞–ø—É—Å–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å GPU –ª–æ–∫–∞–ª—å–Ω–æ)**
```bash
python3 01_download_models.py --output_dir ./models
```

**–í–∞—Ä–∏–∞–Ω—Ç –ë: –ù–∞ HPC —á–µ—Ä–µ–∑ SLURM (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–µ–Ω –∏–Ω—Ç–µ—Ä–Ω–µ—Ç)**
```bash
# –û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ download_models.sbatch, —É–∫–∞–∑–∞–≤ –ø—É—Ç–∏
sbatch download_models.sbatch

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å:
squeue -u $USER
```

–ü–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–∏ –±—É–¥—É—Ç –≤ `./models/flux_dev/` (–ø—Ä–∏–º–µ—Ä–Ω–æ 25GB)

### –®–∞–≥ 3: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø—Ä–æ–º–ø—Ç–æ–≤

–°–æ–∑–¥–∞–π—Ç–µ JSON —Ñ–∞–π–ª —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏ (—Å–º. –ø—Ä–∏–º–µ—Ä `prompts.json`):

```json
{
  "prompt_name_1": {
    "text": "–æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–º–ø—Ç",
    "hints": [
      "–ø–æ–¥—Å–∫–∞–∑–∫–∞ 1",
      "–ø–æ–¥—Å–∫–∞–∑–∫–∞ 2",
      "–ø–æ–¥—Å–∫–∞–∑–∫–∞ 3",
      "–ø–æ–¥—Å–∫–∞–∑–∫–∞ 4",
      "–ø–æ–¥—Å–∫–∞–∑–∫–∞ 5"
    ]
  },
  "prompt_name_2": {
    "text": "–¥—Ä—É–≥–æ–π –ø—Ä–æ–º–ø—Ç",
    "hints": [...]
  }
}
```

### –®–∞–≥ 4: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ HPC –∫–ª–∞—Å—Ç–µ—Ä

```bash
# –° –≤–∞—à–µ–π –º–∞—à–∏–Ω—ã –Ω–∞ HPC:
scp -r models/ user@hpc.cluster:/path/to/project/
scp -r flux_hpc/ user@hpc.cluster:/path/to/project/
```

### –®–∞–≥ 5: –ó–∞–ø—É—Å–∫ –Ω–∞ HPC

```bash
# SSH –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ HPC
ssh user@hpc.cluster

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /path/to/project/flux_hpc

# –°–æ–∑–¥–∞–Ω–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
bash setup_directories.sh

# –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ SLURM
sbatch script.sbatch

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞:
squeue -u $USER

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ (–≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏):
tail -f runs/flux-<JOBID>.log
```

## üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—ã–≤–æ–¥–∞

–ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞, –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ `results/` –±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞ —Å–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞:

```
results/
‚îú‚îÄ‚îÄ prompt_name_1/
‚îÇ   ‚îú‚îÄ‚îÄ without_hints/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ img_0000.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ img_0001.png
‚îÇ   ‚îú‚îÄ‚îÄ with_hints/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ img_hint_0000.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ img_hint_0001.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ img_hint_0002.png
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ img_hint_0003.png
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ img_hint_0004.png
‚îÇ   ‚îî‚îÄ‚îÄ metadata.json
‚îú‚îÄ‚îÄ prompt_name_2/
‚îÇ   ‚îî‚îÄ‚îÄ ...
```

**–î–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è:**
- 2 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ë–ï–ó –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–±–∞–∑–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç)
- 5 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –° –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ (–ø—Ä–æ–º–ø—Ç + —Ä–∞–∑–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏)
- metadata.json —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø—Ä–æ–º–ø—Ç–µ, –ø–æ–¥—Å–∫–∞–∑–∫–∞—Ö –∏ seeds

## ‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `script.sbatch` –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:

```bash
--model_path          # –ü—É—Ç—å –∫ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–π –º–æ–¥–µ–ª–∏
--prompts_file        # JSON —Ñ–∞–π–ª —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏
--output_dir          # –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
--num_without_hints   # –ö–æ–ª-–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –±–µ–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 2)
--num_with_hints      # –ö–æ–ª-–≤–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 5)
--height              # –í—ã—Å–æ—Ç–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1024)
--width               # –®–∏—Ä–∏–Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 1024)
--seed_base           # –ë–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è seed (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 42)
```

## üîß –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### –ü–∞—Ä–∞–º–µ—Ç—Ä—ã SLURM –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ GPU:

**–î–ª—è V100 (type_a, type_b, type_c):**
```bash
#SBATCH --gpus=1
#SBATCH --cpus-per-task=8
#SBATCH --time=2:00:00
```

**–î–ª—è A100 (type_e, —Ç—Ä–µ–±—É–µ—Ç –∑–∞–ø—Ä–æ—Å–∞):**
```bash
#SBATCH --gpus=1
#SBATCH --cpus-per-task=16
#SBATCH --time=1:00:00  # –ë—ã—Å—Ç—Ä–µ–µ –±–ª–∞–≥–æ–¥–∞—Ä—è –º–æ—â–Ω–æ—Å—Ç–∏
```

### –£—Å–∫–æ—Ä–µ–Ω–∏–µ –∏–Ω—Ñ–µ—Ä–µ–Ω—Å–∞:

–í `02_generate_images.py` —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è Flash Attention:
```python
# self.pipeline.enable_attention_slicing()
```

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- **–°–µ–º–µ–Ω–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏**: –í—Å–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≥–µ–Ω–µ—Ä–∏—Ä—É—é—Ç—Å—è —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ seeds –¥–ª—è –≤–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º–æ—Å—Ç–∏
- **–ü–∞–º—è—Ç—å**: FLUX —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∏–º–µ—Ä–Ω–æ 30-40GB VRAM –Ω–∞ V100/A100. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `enable_model_cpu_offload()` –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
- **–í—Ä–µ–º—è**: –û–¥–Ω–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ ~15-30 —Å–µ–∫ –Ω–∞ V100, ~5-10 —Å–µ–∫ –Ω–∞ A100 —Å 50 —à–∞–≥–∞–º–∏ –¥–∏—Ñ—É–∑–∏–∏
- **GPU offloading**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–∫–ª—é—á–µ–Ω –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∏ –ø–∞–º—è—Ç–∏

## üêõ –†–µ—à–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º

### –û—à–∏–±–∫–∞: "CUDA out of memory"
- –£–º–µ–Ω—å—à–∏—Ç–µ `num_inference_steps` –≤ script.sbatch
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ V100 –≤–º–µ—Å—Ç–æ –º–µ–Ω—å—à–∏—Ö GPU
- –†–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ `enable_attention_slicing()`

### –ú–æ–¥–µ–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–∞ HPC
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø—É—Ç—å `--model_path` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –≤ `models/flux_dev/`
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–±—Å–æ–ª—é—Ç–Ω—ã–µ –ø—É—Ç–∏ –≤ script.sbatch

### –î–æ–ª–≥–æ–µ –≤—Ä–µ–º—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
- –≠—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –¥–ª—è FLUX (50 —à–∞–≥–æ–≤ = 15-30 —Å–µ–∫/–∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ)
- –£–º–µ–Ω—å—à–∏—Ç–µ `num_inference_steps` –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è (–∫–∞—á–µ—Å—Ç–≤–æ —Å–Ω–∏–∑–∏—Ç—Å—è)
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ A100 GPU –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–∞

## üìö –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã SLURM

```bash
# –ü—Ä–æ—Å–º–æ—Ç—Ä –æ—á–µ—Ä–µ–¥–∏ –∑–∞–¥–∞–Ω–∏–π
squeue -u $USER

# –û—Ç–º–µ–Ω–∞ –∑–∞–¥–∞–Ω–∏—è
scancel <JOBID>

# –ò—Å—Ç–æ—Ä–∏—è –∑–∞–¥–∞–Ω–∏–π
sacct -u $USER

# –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–¥–∞–Ω–∏–∏
scontrol show job <JOBID>

# –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
sinfo
```

## üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

- [FLUX –Ω–∞ HuggingFace](https://huggingface.co/black-forest-labs/FLUX.1-dev)
- [Diffusers –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://huggingface.co/docs/diffusers)
- [SLURM –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](https://slurm.schedmd.com/sbatch.html)
